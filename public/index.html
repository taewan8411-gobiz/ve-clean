<!doctype html>
<html lang="ko"><meta charset="utf-8" />
<title>온라인수출 애로해소 게시판</title>
<link rel="stylesheet" href="/style.css" />
<body>
<header>
  <div class="container row">
    <h2>온라인수출 애로해소 게시판</h2>
    <nav class="nav right">
      <a href="/index.html" data-nav="home" class="active">홈</a>
      <a href="/new.html" data-nav="new">질문하기</a>
      <a href="/index.html" data-nav="answers">답변보기</a>
    </nav>
  </div>
</header>

<div class="container">
  <div class="card row">
    <select id="cat">
      <option value="">전체 분야</option>
      <option>글로벌셀링</option><option>수출신고</option><option>물류통관</option>
      <option>세무회계</option><option>바이어발굴</option><option>규격인증</option><option>기타</option>
    </select>
    <input id="q" type="search" placeholder="검색: 제목 / 내용 / 분야" />
    <button id="searchBtn" class="primary">검색</button>
    <a class="right" href="/new.html"><button class="primary">+ 새 문의</button></a>
  </div>

  <div id="listWrap" class="card">
    <div id="loading" class="center" style="display:none"><div class="spinner"></div></div>
    <table class="list" id="list"></table>
    <div class="row" id="pager" style="justify-content:flex-end"></div>
  </div>
</div>

<script>
const listEl = document.getElementById('list');
const loadingEl = document.getElementById('loading');
const qEl = document.getElementById('q');
const catEl = document.getElementById('cat');
const pagerEl = document.getElementById('pager');
let page = 1, pageSize = 20, total = 0;

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

async function fetchList(){
  loadingEl.style.display='flex';
  listEl.innerHTML='';
  const q = [qEl.value.trim(), catEl.value.trim()].filter(Boolean).join(' ');
  const res = await fetch(`/api/list?q=${encodeURIComponent(q)}&page=${page}&pageSize=${pageSize}`);
  const data = await res.json();
  loadingEl.style.display='none';

  total = data.total||0;
  listEl.innerHTML = '<tr><th style="width:80px">ID</th><th>제목</th><th style="width:140px">분야</th><th style="width:120px">답변</th><th style="width:180px">작성일</th><th style="width:120px">보기</th></tr>' +
    (data.items||[]).map(p=>{
      const d = new Date(p.createdAt||Date.now());
      return `<tr>
        <td>${p.id}</td>
        <td>${escapeHtml(p.title||'')}</td>
        <td><span class="badge">${escapeHtml(p.category||'')}</span></td>
        <td>${p.answered ? 'Y' : 'N'}</td>
        <td class="muted">${d.toLocaleString()}</td>
        <td><a href="/post.html?id=${p.id}"><button>열기</button></a></td>
      </tr>`;
    }).join('') || '<tr><td colspan="6" class="muted">결과 없음</td></tr>';

  renderPager();
}

function renderPager(){
  const pages = Math.max(1, Math.ceil(total / pageSize));
  pagerEl.innerHTML = '';
  const btn = (label, p, disabled=false) => {
    const b = document.createElement('button');
    b.textContent = label;
    if(disabled){ b.disabled=true; }
    b.addEventListener('click', ()=>{ page=p; fetchList(); });
    pagerEl.appendChild(b);
  };
  btn('«', 1, page===1);
  btn('‹', Math.max(1,page-1), page===1);
  pagerEl.appendChild(document.createTextNode(`  ${page}/${pages}  `));
  btn('›', Math.min(pages,page+1), page===pages);
  btn('»', pages, page===pages);
}

document.getElementById('searchBtn').addEventListener('click', ()=>{ page=1; fetchList(); });
qEl.addEventListener('keydown', e=>{ if(e.key==='Enter'){ page=1; fetchList(); } });
catEl.addEventListener('change', ()=>{ page=1; fetchList(); });

fetchList();
</script>
</body>
</html>
